version: 0.4.0
kind: app
metadata:
  name: "æ¡ä»¶åˆ†æ”¯å¤–éƒ¨çŸ¥è¯†åº“å·¥ä½œæµ"
  description: "æ”¯æŒæ¡ä»¶åˆ†æ”¯ã€å¾ªç¯å’ŒåŠ¨æ€è·¯ç”±çš„æ™ºèƒ½é—®ç­”å·¥ä½œæµ"
  author: "Dify Assistant"
  icon: "ğŸ”€"
  icon_background: "#F3E5F5"
  tags: ["knowledge", "external", "conditional", "workflow", "branching"]
spec:
  app:
    mode: workflow
    icon: "ğŸ”€"
    icon_background: "#F3E5F5"
    name: "æ¡ä»¶åˆ†æ”¯å¤–éƒ¨çŸ¥è¯†åº“å·¥ä½œæµ"
    description: "æ”¯æŒæ¡ä»¶åˆ†æ”¯ã€å¾ªç¯å’ŒåŠ¨æ€è·¯ç”±çš„æ™ºèƒ½é—®ç­”å·¥ä½œæµ"
    tags: ["knowledge", "external", "conditional", "workflow", "branching"]
    workflow:
      graph:
        nodes:
          - id: "start"
            type: "start"
            data:
              title: "å¼€å§‹"
              desc: "å·¥ä½œæµå¼€å§‹èŠ‚ç‚¹"
              variables:
                - variable: "query"
                  label: "ç”¨æˆ·é—®é¢˜"
                  type: "text-input"
                  required: true
                  max_length: 2000
                - variable: "user_type"
                  label: "ç”¨æˆ·ç±»å‹"
                  type: "select"
                  required: false
                  options:
                    - label: "æ™®é€šç”¨æˆ·"
                      value: "user"
                    - label: "ç®¡ç†å‘˜"
                      value: "admin"
                    - label: "å¼€å‘è€…"
                      value: "developer"
                - variable: "priority"
                  label: "ä¼˜å…ˆçº§"
                  type: "select"
                  required: false
                  options:
                    - label: "ä½"
                      value: "low"
                    - label: "ä¸­"
                      value: "medium"
                    - label: "é«˜"
                      value: "high"
                    - label: "ç´§æ€¥"
                      value: "urgent"
          - id: "query_classifier"
            type: "llm"
            data:
              title: "æŸ¥è¯¢åˆ†ç±»å™¨"
              desc: "åˆ†ç±»ç”¨æˆ·æŸ¥è¯¢ç±»å‹å’Œå¤æ‚åº¦"
              model:
                provider: "openai"
                name: "gpt-4o"
                mode: "chat"
                completion_params:
                  temperature: 0.3
                  max_tokens: 300
              prompt_template:
                - role: "system"
                  text: |
                    ä½ æ˜¯ä¸€ä¸ªæŸ¥è¯¢åˆ†ç±»ä¸“å®¶ï¼Œè´Ÿè´£åˆ†æç”¨æˆ·æŸ¥è¯¢å¹¶ç¡®å®šå¤„ç†ç­–ç•¥ã€‚
                    
                    è¯·è¿”å›JSONæ ¼å¼çš„åˆ†ç±»ç»“æœï¼š
                    {
                      "category": "technical|product|support|general",
                      "complexity": "simple|medium|complex",
                      "requires_expert": true|false,
                      "estimated_time": "1-2åˆ†é’Ÿ|5-10åˆ†é’Ÿ|15-30åˆ†é’Ÿ",
                      "suggested_actions": ["action1", "action2"],
                      "confidence": 0.85
                    }
                - role: "user"
                  text: |
                    ç”¨æˆ·æŸ¥è¯¢ï¼š{{#start.query#}}
                    ç”¨æˆ·ç±»å‹ï¼š{{#start.user_type#}}
                    ä¼˜å…ˆçº§ï¼š{{#start.priority#}}
              error_strategy: "fallback"
              retry_config:
                enabled: true
                max_retries: 2
                retry_interval: 1
              default_value_dict:
                text: '{"category": "general", "complexity": "simple", "requires_expert": false, "estimated_time": "1-2åˆ†é’Ÿ", "suggested_actions": ["basic_search"], "confidence": 0.5}'
          - id: "condition_router"
            type: "if-else"
            data:
              title: "æ¡ä»¶è·¯ç”±å™¨"
              desc: "æ ¹æ®æŸ¥è¯¢åˆ†ç±»å’Œç”¨æˆ·ç±»å‹è·¯ç”±åˆ°ä¸åŒçš„å¤„ç†åˆ†æ”¯"
              conditions:
                - id: "technical_complex"
                  logical_operator: "and"
                  conditions:
                    - variable_selector: ["query_classifier", "text"]
                      comparison_operator: "contains"
                      value: "technical"
                    - variable_selector: ["query_classifier", "text"]
                      comparison_operator: "contains"
                      value: "complex"
                - id: "admin_urgent"
                  logical_operator: "and"
                  conditions:
                    - variable_selector: ["start", "user_type"]
                      comparison_operator: "is"
                      value: "admin"
                    - variable_selector: ["start", "priority"]
                      comparison_operator: "is"
                      value: "urgent"
                - id: "developer_technical"
                  logical_operator: "and"
                  conditions:
                    - variable_selector: ["start", "user_type"]
                      comparison_operator: "is"
                      value: "developer"
                    - variable_selector: ["query_classifier", "text"]
                      comparison_operator: "contains"
                      value: "technical"
              logical_operator: "or"
          - id: "expert_knowledge_search"
            type: "knowledge-retrieval"
            data:
              title: "ä¸“å®¶çŸ¥è¯†æ£€ç´¢"
              desc: "ä»ä¸“å®¶çº§çŸ¥è¯†åº“æ£€ç´¢å¤æ‚æŠ€æœ¯é—®é¢˜"
              query_variable_selector: ["start", "query"]
              dataset_ids: ["expert_dataset_id"]
              retrieval_mode: "multiple"
              multiple_retrieval_config:
                top_k: 10
                score_threshold: 0.7
                reranking_mode: "reranking_model"
                reranking_enable: true
                reranking_model:
                  provider: "cohere"
                  model: "rerank-multilingual-v2.0"
              metadata_filtering_mode: "disabled"
              vision:
                enabled: false
              error_strategy: "fallback"
              retry_config:
                enabled: true
                max_retries: 3
                retry_interval: 1
              default_value_dict:
                result: []
          - id: "standard_knowledge_search"
            type: "knowledge-retrieval"
            data:
              title: "æ ‡å‡†çŸ¥è¯†æ£€ç´¢"
              desc: "ä»æ ‡å‡†çŸ¥è¯†åº“æ£€ç´¢ä¸€èˆ¬é—®é¢˜"
              query_variable_selector: ["start", "query"]
              dataset_ids: ["standard_dataset_id"]
              retrieval_mode: "multiple"
              multiple_retrieval_config:
                top_k: 5
                score_threshold: 0.6
                reranking_mode: "reranking_model"
                reranking_enable: true
                reranking_model:
                  provider: "cohere"
                  model: "rerank-multilingual-v2.0"
              metadata_filtering_mode: "disabled"
              vision:
                enabled: false
              error_strategy: "fallback"
              retry_config:
                enabled: true
                max_retries: 3
                retry_interval: 1
              default_value_dict:
                result: []
          - id: "quick_knowledge_search"
            type: "knowledge-retrieval"
            data:
              title: "å¿«é€ŸçŸ¥è¯†æ£€ç´¢"
              desc: "ä»å¿«é€ŸçŸ¥è¯†åº“æ£€ç´¢ç®€å•é—®é¢˜"
              query_variable_selector: ["start", "query"]
              dataset_ids: ["quick_dataset_id"]
              retrieval_mode: "multiple"
              multiple_retrieval_config:
                top_k: 3
                score_threshold: 0.5
                reranking_mode: "reranking_model"
                reranking_enable: false
              metadata_filtering_mode: "disabled"
              vision:
                enabled: false
              error_strategy: "fallback"
              retry_config:
                enabled: true
                max_retries: 2
                retry_interval: 1
              default_value_dict:
                result: []
          - id: "expert_analyzer"
            type: "llm"
            data:
              title: "ä¸“å®¶åˆ†æå™¨"
              desc: "ä½¿ç”¨ä¸“å®¶çº§æ¨¡å‹åˆ†æå¤æ‚æŠ€æœ¯é—®é¢˜"
              model:
                provider: "openai"
                name: "gpt-4o"
                mode: "chat"
                completion_params:
                  temperature: 0.3
                  max_tokens: 3000
                  top_p: 0.9
              prompt_template:
                - role: "system"
                  text: |
                    ä½ æ˜¯ä¸€ä¸ªæŠ€æœ¯ä¸“å®¶ï¼Œè´Ÿè´£åˆ†æå¤æ‚çš„æŠ€æœ¯é—®é¢˜å¹¶æä¾›ä¸“ä¸šè§£ç­”ã€‚
                    
                    è¯·æä¾›ï¼š
                    1. è¯¦ç»†çš„æŠ€æœ¯åˆ†æ
                    2. å¯èƒ½çš„è§£å†³æ–¹æ¡ˆ
                    3. ç›¸å…³çš„æœ€ä½³å®è·µ
                    4. æ½œåœ¨çš„é£é™©å’Œæ³¨æ„äº‹é¡¹
                    5. è¿›ä¸€æ­¥çš„å‚è€ƒèµ„æ–™
                - role: "user"
                  text: |
                    ç”¨æˆ·æŸ¥è¯¢ï¼š{{#start.query#}}
                    ç”¨æˆ·ç±»å‹ï¼š{{#start.user_type#}}
                    æ£€ç´¢ç»“æœï¼š{{#expert_knowledge_search.result#}}
                    æŸ¥è¯¢åˆ†ç±»ï¼š{{#query_classifier.text#}}
              vision:
                enabled: false
              error_strategy: "fallback"
              retry_config:
                enabled: true
                max_retries: 3
                retry_interval: 1
              default_value_dict:
                text: "ä¸“å®¶åˆ†ææš‚æ—¶ä¸å¯ç”¨"
          - id: "standard_analyzer"
            type: "llm"
            data:
              title: "æ ‡å‡†åˆ†æå™¨"
              desc: "ä½¿ç”¨æ ‡å‡†æ¨¡å‹åˆ†æä¸€èˆ¬é—®é¢˜"
              model:
                provider: "openai"
                name: "gpt-3.5-turbo"
                mode: "chat"
                completion_params:
                  temperature: 0.7
                  max_tokens: 1500
                  top_p: 0.9
              prompt_template:
                - role: "system"
                  text: |
                    ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½åŠ©æ‰‹ï¼Œè´Ÿè´£å›ç­”ä¸€èˆ¬æ€§é—®é¢˜ã€‚
                    
                    è¯·æä¾›ï¼š
                    1. æ¸…æ™°çš„è§£ç­”
                    2. ç›¸å…³çš„èƒŒæ™¯ä¿¡æ¯
                    3. å®ç”¨çš„å»ºè®®
                    4. ç›¸å…³èµ„æºé“¾æ¥
                - role: "user"
                  text: |
                    ç”¨æˆ·æŸ¥è¯¢ï¼š{{#start.query#}}
                    ç”¨æˆ·ç±»å‹ï¼š{{#start.user_type#}}
                    æ£€ç´¢ç»“æœï¼š{{#standard_knowledge_search.result#}}
                    æŸ¥è¯¢åˆ†ç±»ï¼š{{#query_classifier.text#}}
              vision:
                enabled: false
              error_strategy: "fallback"
              retry_config:
                enabled: true
                max_retries: 2
                retry_interval: 1
              default_value_dict:
                text: "æ ‡å‡†åˆ†ææš‚æ—¶ä¸å¯ç”¨"
          - id: "quick_analyzer"
            type: "llm"
            data:
              title: "å¿«é€Ÿåˆ†æå™¨"
              desc: "ä½¿ç”¨å¿«é€Ÿæ¨¡å‹åˆ†æç®€å•é—®é¢˜"
              model:
                provider: "openai"
                name: "gpt-3.5-turbo"
                mode: "chat"
                completion_params:
                  temperature: 0.8
                  max_tokens: 800
                  top_p: 0.9
              prompt_template:
                - role: "system"
                  text: |
                    ä½ æ˜¯ä¸€ä¸ªå¿«é€Ÿå“åº”åŠ©æ‰‹ï¼Œè´Ÿè´£å¿«é€Ÿå›ç­”ç®€å•é—®é¢˜ã€‚
                    
                    è¯·æä¾›ï¼š
                    1. ç®€æ´çš„è§£ç­”
                    2. å…³é”®è¦ç‚¹
                    3. å¿«é€Ÿæ“ä½œæŒ‡å—
                - role: "user"
                  text: |
                    ç”¨æˆ·æŸ¥è¯¢ï¼š{{#start.query#}}
                    ç”¨æˆ·ç±»å‹ï¼š{{#start.user_type#}}
                    æ£€ç´¢ç»“æœï¼š{{#quick_knowledge_search.result#}}
                    æŸ¥è¯¢åˆ†ç±»ï¼š{{#query_classifier.text#}}
              vision:
                enabled: false
              error_strategy: "fallback"
              retry_config:
                enabled: true
                max_retries: 2
                retry_interval: 1
              default_value_dict:
                text: "å¿«é€Ÿåˆ†ææš‚æ—¶ä¸å¯ç”¨"
          - id: "result_merger"
            type: "code"
            data:
              title: "ç»“æœåˆå¹¶å™¨"
              desc: "åˆå¹¶ä¸åŒåˆ†æ”¯çš„å¤„ç†ç»“æœ"
              code_language: "python3"
              code: |
                def main(expert_result, standard_result, quick_result, classification, user_type, priority):
                    import json
                    
                    # è§£æåˆ†ç±»ç»“æœ
                    try:
                        classification_data = json.loads(classification)
                        category = classification_data.get('category', 'general')
                        complexity = classification_data.get('complexity', 'simple')
                        confidence = classification_data.get('confidence', 0.5)
                    except:
                        category = 'general'
                        complexity = 'simple'
                        confidence = 0.5
                    
                    # é€‰æ‹©æœ€ä½³ç»“æœ
                    if expert_result and expert_result.strip() != "ä¸“å®¶åˆ†ææš‚æ—¶ä¸å¯ç”¨":
                        selected_result = expert_result
                        result_type = "expert"
                        processing_time = "15-30åˆ†é’Ÿ"
                    elif standard_result and standard_result.strip() != "æ ‡å‡†åˆ†ææš‚æ—¶ä¸å¯ç”¨":
                        selected_result = standard_result
                        result_type = "standard"
                        processing_time = "5-10åˆ†é’Ÿ"
                    elif quick_result and quick_result.strip() != "å¿«é€Ÿåˆ†ææš‚æ—¶ä¸å¯ç”¨":
                        selected_result = quick_result
                        result_type = "quick"
                        processing_time = "1-2åˆ†é’Ÿ"
                    else:
                        selected_result = "æŠ±æ­‰ï¼Œæš‚æ—¶æ— æ³•å¤„ç†æ‚¨çš„é—®é¢˜ã€‚"
                        result_type = "error"
                        processing_time = "0åˆ†é’Ÿ"
                    
                    # ç”Ÿæˆå…ƒæ•°æ®
                    metadata = {
                        "category": category,
                        "complexity": complexity,
                        "user_type": user_type,
                        "priority": priority,
                        "result_type": result_type,
                        "processing_time": processing_time,
                        "confidence": confidence,
                        "timestamp": "2024-01-01T00:00:00Z"
                    }
                    
                    return {
                        "final_answer": selected_result,
                        "metadata": metadata,
                        "success": result_type != "error"
                    }
              error_strategy: "fallback"
              retry_config:
                enabled: true
                max_retries: 2
                retry_interval: 1
              default_value_dict:
                final_answer: "å¤„ç†å¤±è´¥"
                metadata: {}
                success: false
          - id: "quality_controller"
            type: "llm"
            data:
              title: "è´¨é‡æ§åˆ¶å™¨"
              desc: "æ§åˆ¶ç­”æ¡ˆè´¨é‡å’Œç”¨æˆ·æ»¡æ„åº¦"
              model:
                provider: "openai"
                name: "gpt-4o"
                mode: "chat"
                completion_params:
                  temperature: 0.3
                  max_tokens: 500
                  top_p: 0.9
              prompt_template:
                - role: "system"
                  text: |
                    ä½ æ˜¯ä¸€ä¸ªè´¨é‡æ§åˆ¶å™¨ï¼Œè´Ÿè´£è¯„ä¼°ç­”æ¡ˆè´¨é‡å¹¶æä¾›æ”¹è¿›å»ºè®®ã€‚
                    
                    è¯·è¯„ä¼°ä»¥ä¸‹æ–¹é¢å¹¶è¿”å›JSONæ ¼å¼çš„ç»“æœï¼š
                    {
                      "quality_score": 0.85,
                      "completeness": 0.9,
                      "accuracy": 0.8,
                      "user_satisfaction": 0.85,
                      "improvement_suggestions": ["å»ºè®®1", "å»ºè®®2"],
                      "follow_up_questions": ["é—®é¢˜1", "é—®é¢˜2"],
                      "escalation_needed": false
                    }
                - role: "user"
                  text: |
                    åŸå§‹é—®é¢˜ï¼š{{#start.query#}}
                    æœ€ç»ˆç­”æ¡ˆï¼š{{#result_merger.final_answer#}}
                    å¤„ç†å…ƒæ•°æ®ï¼š{{#result_merger.metadata#}}
              vision:
                enabled: false
              error_strategy: "fallback"
              retry_config:
                enabled: true
                max_retries: 2
                retry_interval: 1
              default_value_dict:
                text: '{"quality_score": 0.5, "completeness": 0.5, "accuracy": 0.5, "user_satisfaction": 0.5, "improvement_suggestions": [], "follow_up_questions": [], "escalation_needed": false}'
          - id: "end"
            type: "end"
            data:
              title: "ç»“æŸ"
              desc: "å·¥ä½œæµç»“æŸèŠ‚ç‚¹"
              outputs:
                - value_selector: ["result_merger", "final_answer"]
                  variable: "answer"
                - value_selector: ["result_merger", "metadata"]
                  variable: "processing_info"
                - value_selector: ["quality_controller", "text"]
                  variable: "quality_assessment"
        edges:
          - id: "start-to-classifier"
            source: "start"
            target: "query_classifier"
          - id: "classifier-to-router"
            source: "query_classifier"
            target: "condition_router"
          - id: "router-to-expert-search"
            source: "condition_router"
            target: "expert_knowledge_search"
            condition: "technical_complex"
          - id: "router-to-standard-search"
            source: "condition_router"
            target: "standard_knowledge_search"
            condition: "admin_urgent"
          - id: "router-to-quick-search"
            source: "condition_router"
            target: "quick_knowledge_search"
            condition: "developer_technical"
          - id: "expert-search-to-analyzer"
            source: "expert_knowledge_search"
            target: "expert_analyzer"
          - id: "standard-search-to-analyzer"
            source: "standard_knowledge_search"
            target: "standard_analyzer"
          - id: "quick-search-to-analyzer"
            source: "quick_knowledge_search"
            target: "quick_analyzer"
          - id: "expert-analyzer-to-merger"
            source: "expert_analyzer"
            target: "result_merger"
          - id: "standard-analyzer-to-merger"
            source: "standard_analyzer"
            target: "result_merger"
          - id: "quick-analyzer-to-merger"
            source: "quick_analyzer"
            target: "result_merger"
          - id: "classifier-to-merger"
            source: "query_classifier"
            target: "result_merger"
          - id: "merger-to-controller"
            source: "result_merger"
            target: "quality_controller"
          - id: "controller-to-end"
            source: "quality_controller"
            target: "end"
      features:
        file_upload:
          enabled: false
        opening_statement: "æ‚¨å¥½ï¼æˆ‘æ˜¯æ™ºèƒ½æ¡ä»¶åˆ†æ”¯åŠ©æ‰‹ï¼Œä¼šæ ¹æ®æ‚¨çš„é—®é¢˜ç±»å‹å’Œç”¨æˆ·æƒé™æä¾›æœ€é€‚åˆçš„è§£ç­”ã€‚è¯·å‘Šè¯‰æˆ‘æ‚¨çš„é—®é¢˜ã€‚"
        suggested_questions: 
          - "å¦‚ä½•æé«˜æŸ¥è¯¢çš„å‡†ç¡®æ€§ï¼Ÿ"
          - "ä¸åŒç”¨æˆ·ç±»å‹æœ‰ä»€ä¹ˆæƒé™å·®å¼‚ï¼Ÿ"
          - "å¦‚ä½•å¤„ç†å¤æ‚çš„æŠ€æœ¯é—®é¢˜ï¼Ÿ"
          - "å¦‚ä½•è®¾ç½®é—®é¢˜ä¼˜å…ˆçº§ï¼Ÿ"
        suggested_questions_after_answer:
          enabled: true
        speech_to_text:
          enabled: false
        text_to_speech:
          enabled: false
        citation: true
        retriever_resource:
          enabled: true
        sensitive_word_avoidance:
          enabled: false
        more_like_this:
          enabled: true
        user_input_form: []
        system_parameters: []